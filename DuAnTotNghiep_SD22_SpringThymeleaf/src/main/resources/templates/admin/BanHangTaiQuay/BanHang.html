<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bán hàng tại quầy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

    <link rel="icon" type="image/svg+xml"
          href="https://bizweb.dktcdn.net/100/048/601/themes/734017/assets/index-cate-icon-4.png?1610907247309"/>
    <head th:replace="~{admin/fragments/head :: head}"></head>


    <style>
        /*.tab {*/
        /*    border-top-left-radius: 8px;*/
        /*    border-top-right-radius: 8px;*/
        /*}*/

        /*.tab-active {*/
        /*    background-color: white;*/
        /*    border: 1px solid #e5e7eb;*/
        /*    border-bottom: none;*/
        /*}*/

        .tab-active {
            background-color: #ffffff;
            color: #333;
            font-weight: bold;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .tab {
            background-color: #FFFFFF;
            color: #333;
            border-radius: 4px;
        }

        #toggle-button, #traSau-button {
            background-color: #e0e0e0;
            border-radius: 9999px;
            display: inline-flex;
            align-items: center;
            height: 24px;
            width: 48px;
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .toggle-dot {
            background-color: #ffffff;
            border-radius: 9999px;
            height: 16px;
            width: 16px;
            position: absolute;
            top: 50%;
            left: 4px;
            transform: translateY(-50%);
            transition: transform 0.2s;
        }

        #toggle-button.active, #traSau-button.active {
            background-color: #2986cc;
        }

        #toggle-button.active .toggle-dot, #traSau-button.active .toggle-dot {
            transform: translateY(-50%) translateX(24px);
        }

        #traSau-button[disabled] {
            background-color: #e0e0e0;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .d-none {
            display: none;
        }


        #toggle-button {
            background-color: #e0e0e0;
            border-radius: 9999px;
            display: inline-flex;
            align-items: center;
            height: 24px;
            width: 48px;
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .toggle-dot {
            background-color: #ffffff;
            border-radius: 9999px;
            height: 16px;
            width: 16px;
            position: absolute;
            top: 50%;
            left: 4px;
            transform: translateY(-50%);
            transition: transform 0.2s;
        }

        #toggle-button.active {
            background-color: #2986cc;
        }

        #toggle-button.active .toggle-dot {
            transform: translateY(-50%) translateX(24px);
        }
        #interactive {
            width: 320px;
            height: 240px;
            overflow: hidden;
            background-color: #000;
        }
        #modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        #modal-content {
            position: absolute;
            width: 320px;
            height: 240px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        #modal-content h3 {
            margin: 0;
            padding: 10px;
            background-color: #333;
            color: white;
            text-align: center;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            width: 300px;
            text-align: center;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 1000;
            color: white;
        }

        .notification.thanhCong {
            background-color: #4CAF50;
        }

        .notification.thatBai {
            background-color: #f44336;
        }

        .notification .progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background-color: #fff;
            transition: width 3s linear;
        }

    </style>
</head>
<body >
<div class="flex">
    <!-- Sidebar Start -->
    <div th:replace="~{admin/fragments/sidebar :: sidebar}" class="w-64"></div>
    <!-- Sidebar End -->
    <!-- Content Start -->
    <div class="content flex-grow ml-64 p-4 bg-gray-200">
        <!-- Navbar Start -->
        <nav th:replace="~{admin/fragments/navbar :: nav}"></nav>
        <!-- Navbar End -->
        <!-- Main Content -->
<div class="mx-auto bg-white rounded-lg shadow">
    <div class="p-4 flex justify-between items-center">
        <h2 class="text-xl font-semibold"></h2>
        <button id="add-tab" class="px-4 py-2 bg-blue-500 text-white rounded-full">Tạo hóa đơn</button>
    </div>
    <div class="border-b">
        <div id="tabs-container" class="flex space-x-2 ml-3">
        </div>
    </div>
    <div class="p-4">
        <div class="grid gap-4 grid-cols-2 mb-5">
            <div >
                <button class="bg-blue-500 hover:bg-blue-700 text-white py-1 px-2 rounded mr-3"
                >Danh sách sản phẩm
                </button>

            </div>
            <div class="flex justify-end">
<!--                <div id="barcode-scanner">-->
<!--                        <div id="result">-->
<!--&lt;!&ndash;                            <strong></strong><span id="scanned-barcode"></span>&ndash;&gt;-->
<!--                        </div>-->
<!--                    <div id="error-message"></div>-->
<!--                <button class="bg-blue-500 hover:bg-blue-700 text-white py-1 px-2 rounded mr-3"-->
<!--                        id="start-camera"><svg xmlns="http://www.w3.org/2000/svg" version="1.1" id="mdi-barcode-scan" width="24" height="24" viewBox="0 0 24 24">-->
<!--                    <path fill="#FFFFFF" d="M4,6H6V18H4V6M7,6H8V18H7V6M9,6H12V18H9V6M13,6H14V18H13V6M16,6H18V18H16V6M19,6H20V18H19V6M2,4V8H0V4A2,2 0 0,1 2,2H6V4H2M22,2A2,2 0 0,1 24,4V8H22V4H18V2H22M2,16V20H6V22H2A2,2 0 0,1 0,20V16H2M22,20V16H24V20A2,2 0 0,1 22,22H18V20H22Z"/>-->
<!--                </svg>-->
<!--                </button>-->
<!--                </div>-->

                <button class="bg-blue-500 hover:bg-blue-700 text-white py-1 px-2 rounded"
                        id="hienThiDanhSachSanPham" >Thêm sản phẩm
                </button>
            </div>
        </div>
        <div class="w-full border-t border-gray-500 mt-1 mb-3 "></div>

        <div id="content-container" class="">
        </div>

        <div class="mt-5">
            <div class="w-full border-t border-gray-500 mt-1 mb-3 "></div>
            <div class="grid gap-4 grid-cols-2 mt-14">
                <div>
                    <h1 class="font-bold text-xl">Tài hhoản</h1>

                </div>
                <div>
                    <button id="chonTaiKhoan" class=" ml-[60%] bg-blue-500 hover:bg-blue-700 text-white py-1 px-2 rounded"
                             >Chọn tài khoản
                    </button>
                </div>
            </div>
            <div class="w-full border-t border-gray-500 mt-1 mb-3 "></div>
            <div id="thongTinNguoiMua" class="mb-20">

            </div>
            <div>
                <h1 class="font-bold text-xl">Khách hàng</h1>
                <div class="w-full border-t border-gray-500 mt-1 mb-3 "></div>

                <div class="grid gap-4 grid-cols-2">

                    <div id="thongTinShip2" class="thongTinShip2"></div>

                    <div id="thongTinShip" class="thongTinShip hidden">
                        <form id="chinh-sua-form" >
                            <div class="form-group">
                                <label for="edit-ten" class="block text-sm font-medium text-gray-700">Tên Khách Hàng</label>
                                <input type="text" id="edit-ten" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" value="">
                            </div>

                            <div class="form-group">
                                <label for="edit-sdtNguoiNhan" class="block text-sm font-medium text-gray-700">Số điện thoại</label>
                                <input type="text" id="edit-sdtNguoiNhan" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" value="">
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="form-group">
                                    <label for="edit-tinhthanh" class="block text-sm font-medium text-gray-700">Tỉnh/Thành phố</label>
                                    <select id="edit-tinhthanh" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                        <option value="" selected>Chọn tỉnh thành</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="edit-quanhuyen" class="block text-sm font-medium text-gray-700">Quận/Huyện</label>
                                    <select id="edit-quanhuyen" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                        <option value="" selected>Chọn quận huyện</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="edit-phuongxa" class="block text-sm font-medium text-gray-700">Phường/Xã</label>
                                    <select id="edit-phuongxa" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                        <option value="" selected>Chọn phường xã</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="edit-diachi" class="block text-sm font-medium text-gray-700">Địa chỉ cụ thể</label>
                                <input type="text" id="edit-diachi" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            </div>

                            <div class="form-group">
                                <label for="phiVanChuyen" class="block text-sm font-medium text-gray-700">Phí vận chuyển</label>
                                <input type="number" id="phiVanChuyen" min="0" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="0 VNĐ">
                            </div>

                            <div class="form-group">
                                <label for="noteThongTin" class="block text-sm font-medium text-gray-700">Ghi chú</label>
                                <textarea id="noteThongTin" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" rows="4"></textarea>
                            </div>
                        </form>

                        <div class="flex">
                            <img src="https://cdn.haitrieu.com/wp-content/uploads/2022/05/Logo-GHN-Slogan-En.png" class="w-[20%] h-[20%]">
                            <p class="ml-10">Thời gian dự kiện: <span id="thoiGianDuKien"></span></p>
                        </div>


                    </div>
                    <div class="grid gap-2 grid-cols-2">
                        <div>
                            <p class="m-10 flex items-center gap-2">Khách thanh toán:
                                <span class="ml-14">
                                     <button id="thanhToan">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 0 0 2.25-2.25V6.75A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25v10.5A2.25 2.25 0 0 0 4.5 19.5Z" />
                                        </svg>
                                    </button>
                                </span>

                            </p>
                            <p class="m-10">Mã giảm giá:</p>
                            <p class="flex items-center gap-2 m-10">
                                Giao hàng:
                                <button id="toggle-button" class="flex items-center mt-2 ml-5">
                                    <span class="toggle-dot"></span>
                                </button>

                            </p>
                            <div class="flex items-center gap-2 m-10">
                                <span class="label">Trả sau:</span>
                                <button id="traSau-button" class="flex items-center ml-5" disabled>
                                    <span class="toggle-dot"></span>
                                </button>
                            </div>
                            <p class="m-10">Tiền hàng:</p>
                            <p class="m-10">Giảm giá:</p>
                            <p class="m-10">Tổng tiền:</p>
                        </div>
                            <div id="thongTinThanhToan">
                            </div>
                        </div>
                </div>
            </div>
            <button id="thanhToanTong" class="bg-blue-500 text-white px-4 py-2 rounded h-[50%] mt-1 hover:bg-blue-600 hover:text-gray-100 ml-[80%]">Thanh Toán
            </button>
        </div>
    </div>
</div>

<div id="modal">
    <div id="modal-content">
        <h3>Scanning...</h3>
        <div id="interactive" class="viewport"></div>
        </div>
    </div>

<div id="modalDachSachSanPham" class="fixed inset-0 overflow-y-auto hidden bg-gray-500 bg-opacity-75 ml-20">
    <div class="flex items-center justify-center min-h-screen">
        <div class="bg-white rounded-lg overflow-hidden shadow-xl w-[70%] h-[80%]">
            <div class="bg-white px-4 pt-5 pb-4">
                <div class="flex items-center space-x-4 mb-3">
                    <input id="input-TimKiem" type="text" class="flex-1 bg-white border border-gray-300 hover:border-gray-500 px-4 py-2 rounded shadow leading-tight focus:outline-none focus:shadow-outline" placeholder="Tìm kiếm...">
                    <button id="timKiemBlaBla" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Tìm kiếm</button>
                    <button id="tuBoTatCa" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Làm mới</button>
                </div>

                <div class="flex mb-3">
                    <div class="w-full max-w-xs flex items-center space-x-2">
                        <label for="combo-box-mau-sac" class="text-gray-700 text-sm font-bold">Kích cỡ :</label>
                        <select id="combo-box-kich-co" class="block appearance-none w-[50%] bg-white border border-gray-300 hover:border-gray-500 px-4 py-2 pr-8 rounded shadow leading-tight focus:outline-none focus:shadow-outline">
                            <option value="">Tất cả</option>
                        </select>
                    </div>
                    <div class="w-full max-w-xs flex items-center space-x-2">
                        <label for="combo-box-mau-sac" class="text-gray-700 text-sm font-bold">Màu sắc:</label>
                        <select id="combo-box-mau-sac" class="block appearance-none w-[50%] bg-white border border-gray-300 hover:border-gray-500 px-4 py-2 pr-8 rounded shadow leading-tight focus:outline-none focus:shadow-outline">
                            <option value="">Tất cả</option>
                        </select>
                    </div>
                    <div class="w-full max-w-xs flex items-center space-x-2">
                        <label for="combo-box-chat-lieu" class="text-gray-700 text-sm font-bold">Chất liệu:</label>
                        <select id="combo-box-chat-lieu" class="block appearance-none w-[50%] bg-white border border-gray-300 hover:border-gray-500 px-4 py-2 pr-8 rounded shadow leading-tight focus:outline-none focus:shadow-outline">
                            <option value="">Tất cả</option>
                        </select>
                    </div>
                    <div class="w-full max-w-xs flex items-center space-x-2">
                        <label for="combo-box-co-giay" class="text-gray-700 text-sm font-bold">Cổ giày:</label>
                        <select id="combo-box-co-giay" class="block appearance-none w-[50%] bg-white border border-gray-300 hover:border-gray-500 px-4 py-2 pr-8 rounded shadow leading-tight focus:outline-none focus:shadow-outline">
                            <option value="">Tất cả</option>
                        </select>
                    </div>
                </div>
                <div class="flex ml-[6%] mb-3">
                    <div class="w-full max-w-xs flex items-center space-x-2">
                        <label for="combo-box-de-giay" class="text-gray-700 text-sm font-bold">Đế giày:</label>
                        <select id="combo-box-de-giay" class="block appearance-none w-[50%] bg-white border border-gray-300 hover:border-gray-500 px-4 py-2 pr-8 rounded shadow leading-tight focus:outline-none focus:shadow-outline">
                            <option value="">Tất cả</option>
                        </select>
                    </div>
                    <div class="w-full max-w-xs flex items-center space-x-2">
                        <label for="combo-box-thuong-hieu" class="text-gray-700 text-sm font-bold">Thương hiệu:</label>
                        <select id="combo-box-thuong-hieu" class="block appearance-none w-[50%] bg-white border border-gray-300 hover:border-gray-500 px-4 py-2 pr-8 rounded shadow leading-tight focus:outline-none focus:shadow-outline">
                            <option value="">Tất cả</option>
                        </select>
                    </div>
                </div>
                <table id="tableDanhSachSanPham" class="min-w-full divide-y divide-gray-200 overflow-hidden">
                    <thead class="bg-blue-500">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">
                            STT
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">
                            Ảnh
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">
                            Tên Sản Phẩm
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">
                            Giá Bán
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">
                            Số Lượng
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">
                            Kích Thước
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">
                            Màu Sắc
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">
                            Trạng Thái
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">
                            Hành Động
                        </th>
                    </tr>
                    </thead>
                    <tbody id="danhSachSanPham" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
            <div id="paginationSP" class="flex justify-center mt-4"></div>
            <div class="flex justify-end mb-3 mr-3">
                <button id="dongDanhSachSanPham"
                        class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 hover:text-gray-100">
                    Xác nhận
                </button>
            </div>
        </div>

    </div>
</div>

</div>
</div>

<div id="modalKhachHang" class="fixed inset-0 overflow-y-auto hidden bg-gray-500 bg-opacity-75 ml-20">
    <div class="flex items-center justify-center min-h-screen">
        <div class="bg-white rounded-lg overflow-hidden shadow-xl w-[70%] max-h-[80%]">
            <div class="bg-white px-4 pt-5 pb-4">
                <div class="flex items-center space-x-4 mb-3">
                    <input id="input-TimKiemSDT" type="text" class="flex-1 bg-white border border-gray-300 hover:border-gray-500 px-4 py-2 rounded shadow leading-tight focus:outline-none focus:shadow-outline" placeholder="Tìm kiếm...">
                    <button id="timKiemSDT" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Tìm kiếm</button>
                    <button id="tuBoTatCaSDT" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Làm mới</button>
                </div>
                <table id="tableKhachHang" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-blue-500">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">
                            STT
                        </th>

                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">
                            Tên khách hàng
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">
                            Email
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">
                            Số điện thoại
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">
                            Hành động
                        </th>
                    </tr>
                    </thead>
                    <tbody id="listKhachHang" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
            <div id="pagination" class="flex justify-center mt-4"></div>
            <div class="flex justify-end mb-3 mr-3">
                <button id="themKH"
                        class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 hover:text-gray-100 mr-3">
                    Thêm khách hàng
                </button>
                <button id="dongKhachHang"
                        class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 hover:text-gray-100">
                    Xác nhận
                </button>
            </div>
        </div>

    </div>
</div>


<div id="modalThemKhachHang" class="fixed inset-0 overflow-y-auto hidden bg-gray-500 bg-opacity-75 ml-20">

    <div class="flex items-center justify-center min-h-screen mb-5">
        <div class="bg-white rounded-lg overflow-hidden shadow-xl w-[40%] max-h-[80%]">
            <div class="bg-white px-4 pt-5 pb-4">
                <span class="ml-5 mb-10 text-2xl font-bold">Thêm khách hàng</span>

               <div class="mb-5 mt-3">
                   <label class="ml-3 ">Tên Khách hàng</label>
                   <div class="flex items-center space-x-4 mb-3">

                       <input id="tenKH" type="text" class="ml-3 flex-1 bg-white border border-gray-300 hover:border-gray-500 px-4 py-2 rounded shadow leading-tight focus:outline-none focus:shadow-outline" placeholder="Tìm kiếm...">
                   </div>
                   <label class="ml-3 ">Số điện thoại</label>
                   <div class="flex items-center space-x-4 mb-3">

                       <input id="SDT" type="number" class="ml-3 flex-1 bg-white border border-gray-300 hover:border-gray-500 px-4 py-2 rounded shadow leading-tight focus:outline-none focus:shadow-outline" placeholder="Tìm kiếm...">
                   </div>
               </div>
                <div class="flex justify-end mb-3 mr-3 mt-3">
                    <button id="dongThemKhachHang"
                            class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 hover:text-gray-100">
                        Hủy
                    </button>

                    <button id="dongYThemKhachHang"
                            class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 hover:text-gray-100 ml-3">
                        Thêm khách hàng
                    </button>
                </div>
            </div>
        </div>

    </div>
</div>


<div id="modalSoLuong" class="fixed z-10 inset-0 overflow-y-auto hidden">
    <div class="flex items-center justify-center min-h-screen px-4 py-6">
        <div class="fixed inset-0 transition-opacity" aria-hidden="true">
            <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
        </div>
        <div class="bg-white rounded-lg overflow-hidden shadow-xl transform transition-all max-w-md w-full p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold">Số lượng</h2>
                <button id="dongModalSoLuong" class="text-gray-500 hover:text-gray-900 text-2xl font-bold ml-4">
                    &times;
                </button>
            </div>
            <div>
                <input type="number" id="soLuongInput" value="1" min="1" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <button id="soLuongThayDoi" class="mt-4 w-full py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    Confirm
                </button>
            </div>
        </div>
    </div>
</div>

<div id="modalThanhToan" class="fixed inset-0 overflow-y-auto hidden bg-gray-500 bg-opacity-75 ml-20">
    <div class="flex items-center justify-center min-h-screen">
        <div class="bg-white rounded-lg overflow-hidden shadow-xl w-[45%] max-h-[80%]">
            <div class="bg-white px-4 pt-5 pb-4">
                <p class="mb-3 text-xl">Thanh toán</p>
                <div class="w-full flex flex-col space-y-4">
                    <div class="flex items-center space-x-4">
                        <label class="text-gray-700 font-semibold text-sm">Tiền khách đưa</label>
                        <input id="inputSoTien" type="text" class="border border-gray-300 focus:border-black focus:outline-none p-2 rounded-md text-sm flex-1" placeholder="Nhập số tiền" value="">
                    </div>
                   <div class="grid gap-2 grid-cols-2">
                       <button id="btnTienMat" type="button" class="focus:outline-none text-white bg-green-600 hover:bg-green-700 focus:ring-4 focus:ring-green-300 font-medium rounded-lg text-sm px-5 py-2.5 w-full">
                           Tiền mặt
                       </button>
                       <button id="btnChuyenKhoan" type="button" class="focus:outline-none text-white bg-green-600 hover:bg-green-700 focus:ring-4 focus:ring-green-300 font-medium rounded-lg text-sm px-5 py-2.5 w-full">
                           CHuyển khoản
                       </button>
                   </div>
                </div>

                <div id="tienThieu" class="flex items-center mt-2">

                </div>

                <table id="tablePhuongThucThanhToan" class="min-w-full divide-y divide-gray-200 mt-2">
                    <thead class="bg-blue-500">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">
                            STT
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">
                            Số tiền
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">
                            Phương thức
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">
                            Hành động
                        </th>
                    </tr>
                    </thead>
                    <tbody id="listPhuongThucThanhToan" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
            <div class="flex items-center gap-2 m-10">
                <div class="font-bold">
                    <p>Tiền khách đưa: </p>
                    <p>Tổng tiền: </p>
                    <p>Tiền còn thiếu: </p>

                </div>
                <div class="font-bold">
                    <p id="tienKhachDuoc" class="text-red-500 ml-80">0</p>
                    <p id="tienThieu2" class="text-red-500 ml-80">0</p>

                    <p id="tienConThieu" class="text-red-500 ml-80">0</p>

                </div>
            </div>

            <div class="flex justify-end mb-3 mr-3">
                <button id="xacNhanThanhToan" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 hover:text-gray-100">
                    Xác nhận
                </button>
            </div>
        </div>
    </div>
</div>

<div id="notification" class="notification">
    <span id="notification-message"></span>
    <div id="progress-bar" class="progress-bar"></div>
</div>


<script>
    $(document).ready(function () {

        var $editDiaChi = $('#edit-diachi');
        var $editTinhThanh = $('#edit-tinhthanh');
        var $editQuanHuyen = $('#edit-quanhuyen');
        var $editPhuongXa = $('#edit-phuongxa');


        var citiesData = [];
        let idSP = [];
        var idPGG = null;
        var maPGG = '';
        var GiamToiDa = 0;
        var tienDaThanhToan = 0;
        var countHD = 0;
        var tienKhachDaTra = 0;
        var maHD = null;



        var tienConThieu = 0;

        let checkThanhToan = 0;

        var tongTienTrongHD = 0;

        var tongTienSauKhiCoVoucher = 0;



        let tabsData = [];
        var idTabHD = null;

        var ten, sdtNguoiNhan, tinhthanh, quanhuyen, phuongxa, diachi, phiVanChuyen, noteThongTin, fullAddress;

        function getFormData() {
            ten = $('#edit-ten').val().trim();
            sdtNguoiNhan = $('#edit-sdtNguoiNhan').val().trim();
            tinhthanh = $('#edit-tinhthanh').val().trim();
            quanhuyen = $('#edit-quanhuyen').val().trim();
            phuongxa = $('#edit-phuongxa').val().trim();
            diachi = $('#edit-diachi').val().trim();
            phiVanChuyen = $('#phiVanChuyen').val().trim();
            noteThongTin = $('#noteThongTin').val().trim();

            console.log("Tên:", ten);
            console.log("SĐT Người Nhận:", sdtNguoiNhan);
            console.log("Tỉnh Thành:", tinhthanh);
            console.log("Quận Huyện:", quanhuyen);
            console.log("Phường Xã:", phuongxa);
            console.log("Địa Chỉ:", diachi);
            console.log("Phí Vận Chuyển:", phiVanChuyen);
            console.log("Ghi Chú:", noteThongTin);

            fullAddress = '';
            if (diachi) fullAddress += diachi;
            if (phuongxa) {
                if (fullAddress) fullAddress += ', ';
                fullAddress += getAddressName(phuongxa, 'phuongxa');
            }
            if (quanhuyen) {
                if (fullAddress) fullAddress += ', ';
                fullAddress += getAddressName(quanhuyen, 'quanhuyen');
            }
            if (tinhthanh) {
                if (fullAddress) fullAddress += ', ';
                fullAddress += getAddressName(tinhthanh, 'tinhthanh');
            }

            console.log("Full Address:", fullAddress);
        }

        getThongTinKhachHang();

        function getAddressName(id, type) {
            if (!citiesData.length) return id;

            let address = '';

            switch(type) {
                case 'tinhthanh':
                    let city = citiesData.find(city => city.Id === id);
                    address = city ? city.Name : id;
                    break;
                case 'quanhuyen':
                    let district = citiesData.flatMap(city => city.Districts).find(district => district.Id === id);
                    address = district ? district.Name : id;
                    break;
                case 'phuongxa':
                    let ward = citiesData.flatMap(city => city.Districts.flatMap(district => district.Wards)).find(ward => ward.Id === id);
                    address = ward ? ward.Name : id;
                    break;
            }

            return address;
        }


        const formatVND = (tongtien) => {
            if (tongtien < 0) {
                tongtien = 0;
            }
            return tongtien.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".") + ' VNĐ';
        }

        const tabsContainer = document.getElementById('tabs-container');
        const contentContainer = document.getElementById('content-container');

        function renderTabs() {
            tabsContainer.innerHTML = '';
            contentContainer.innerHTML = '';

            tabsData.forEach((tab, index) => {
                const tabButton = document.createElement('button');
                tabButton.classList.add('tab', 'px-4', 'py-2', 'bg-gray-200', 'hover:bg-gray-300');
                if (index === 0) tabButton.classList.add('tab-active');
                tabButton.textContent = tab.title;
                tabButton.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('tab-active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));

                    tabButton.classList.add('tab-active');
                    const tabContent = document.getElementById(`tab-content-${tab.id}`);
                    tabContent.classList.remove('hidden');


                    idTabHD = tab.id;
                    PhieuGiamGiaPhuHop(tongTienTrongHD);

                    getDuLieu(idTabHD);
                    getPhuongThucThanhToan(idTabHD);
                    if (!tabsData[index].contentLoaded) {
                        // getDuLieu(tab.id);
                    }
                });
                tabsContainer.appendChild(tabButton);

                const tabContent = document.createElement('div');
                tabContent.id = `tab-content-${tab.id}`;
                tabContent.classList.add('tab-content', 'p-4');
                if (index !== 0) tabContent.classList.add('hidden');
                tabContent.innerHTML = tab.content;
                contentContainer.appendChild(tabContent);
            });

            if (tabsData.length > 0) {
                document.querySelector('.tab').click();
            }
        }



        document.getElementById('add-tab').addEventListener('click', () => {
            if(countHD >= 10){
                showNotification("Thêm hóa đơn thất bại", 'thatBai');
            } else {
                taoHoaDon();
            }
        });

        function taoHoaDon() {
            $.ajax({
                url: `/api/ban-hang/tao-hoa-don`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({}),
                success: function (response) {
                    idHoaDon(() => {
                        const lastTabIndex = tabsData.length - 1;
                        document.querySelectorAll('.tab').forEach(t => t.classList.remove('tab-active'));
                        document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));

                        document.querySelectorAll('.tab')[lastTabIndex].classList.add('tab-active');
                        document.querySelectorAll('.tab-content')[lastTabIndex].classList.remove('hidden');
                        PhieuGiamGiaPhuHop(tongTienTrongHD);

                        getDuLieu(tabsData[lastTabIndex].id);
                    });
                    showNotification("Tạo hóa đơn thành công", "thanhCong");
                },
            });
        }

        function idHoaDon(callback) {
            $.ajax({
                url: `/api/ban-hang`,
                method: 'GET',
                success: function (response) {
                    countHD = response.length;
                    tabsData = response.map((hd, index) => ({
                        id: hd.id,
                        title: `Hóa đơn ${hd.id}`,
                        content: '',
                        contentLoaded: false
                    }));
                    PhieuGiamGiaPhuHop(tongTienTrongHD);

                    renderTabs();
                    if (callback) callback();
                },
                error: function (xhr, status, error) {
                    console.error('Lỗi:', error);
                }
            });
        }


        function getDuLieu(idHoaDon) {
            tongTienTrongHD = 0;
            tongTienSauKhiCoVoucher = 0;
            tienKhachDaTra = 0;
            $('#tienThieu2').text(`${formatVND((0))}`);
            $('#tienConThieu').text(`${formatVND((0))}`);


            $.ajax({
                url: `/api/ban-hang/${idHoaDon}`,
                method: 'GET',
                success: function (response) {
                    const hd = response.hd;
                    const hdctList = response.hdctList;
                    idSP = [];

                    maHD = hd.ma


                    let tongTienHDCT = 0;

                    for (let i = 0; i < hdctList.length; i++) {
                        let item = hdctList[i];
                        idSP.push({
                            id: item.sanPhamChiTiet.id,
                            soLuong: item.soLuong,
                            giaBan: item.gia
                        });

                        tongTienTrongHD += item.soLuong * item.gia;
                        tongTienHDCT += item.soLuong * item.gia;

                    }

                    console.log(hd.diaChiNguoiNhan);
                    splitAndPopulateAddress(hd.diaChiNguoiNhan);


                    tongTienSauKhiCoVoucher = tongTienHDCT - GiamToiDa;
                    $('#tienThieu2').text(`${formatVND(tongTienSauKhiCoVoucher)}`);
                    $('#tienConThieu').text(`${formatVND(tongTienSauKhiCoVoucher - tienDaThanhToan)}`);

                    console.log(GiamToiDa)
                    console.log(tongTienHDCT)
                    console.log(tongTienHDCT)

                    PhieuGiamGiaPhuHop(tongTienHDCT);
                    PhieuGiamGiaPhuHop(tongTienHDCT)
                    addPhieuGiamGia(idHoaDon, idPGG);
                    getPhuongThucThanhToan(idHoaDon);
                    xoaPhuongThucThanhToan(idHoaDon);
                    cbbChatLieu();
                    cbbDeGiay();
                    cbbThuongHieu();
                    cbbCoGiay();
                    cbbKichCo();
                    cbbMauSac();
                    xoaSanPham(idHoaDon);
                    hienThiThongTinNguoiMua(hd);
                    thongTinShip(hd);

                    const tabContent = document.getElementById(`tab-content-${idHoaDon}`);
                    if (!hdctList || !Array.isArray(hdctList) || hdctList.length === 0) {
                        tabContent.innerHTML = `
                        <div class="content bg-white flex flex-col items-center justify-center py-12">
                            <div class="text-center">
                                <img src="https://www.fotofabrikas.lt/data/upload/images/page/empty_cart.png" alt="Empty Cart" class="w-1/2 mx-auto mb-6">
                                <p class="text-gray-500 text-2xl mb-4">Không có sản phẩm trong giỏ hàng</p>
                                <p class="text-gray-500 mb-4"></p>
                            </div>
                        </div>`;
                    } else {
                        tabContent.innerHTML = `
                            <table id="tableHoaDonChiTiet" class="divide-y divide-gray-200 w-full">
                                <thead class="bg-blue-500 text-white">
                                    <tr>
                                        <th class="px-6 py-3 text-left">STT</th>
                                        <th class="px-6 py-3 text-left">Ảnh sản phẩm</th>
                                        <th class="px-6 py-3 text-left">Sản phẩm</th>
                                        <th class="px-6 py-3 text-left">Số lượng</th>
                                        <th class="px-6 py-3 text-left">Tổng tiền</th>
                                        <th class="px-6 py-3 text-left">Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${hdctList.map((hdct, index) => `
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap">${index + 1}</td>
                                            <td class="px-6 py-4 whitespace-nowrap"> <img src="${hdct.sanPhamChiTiet.anh}" alt="Ảnh" class="w-16 h-auto"></td>
                                            <td class="px-6 py-4 whitespace-nowrap font-bold">
                                                <h1>${hdct.sanPhamChiTiet.ten}-${hdct.sanPhamChiTiet.mauSac.moTa}</h1>
                                                <h2 class="text-red-600">${formatVND(hdct.sanPhamChiTiet.giaBan)}</h2>
                                                <h2 class="font-normal">Kích cỡ: ${hdct.sanPhamChiTiet.kichCo.ten}</h2>
                                            </td>
                                            <td class="flex items-center mt-5">
                                                <input type="number" class="soLuong-input bg-gray-100 w-[30%] border border-gray-300 rounded-md px-2 py-1" value="${hdct.soLuong}" min="1" data-id="${hdct.id}" id="soLuong-${hdct.id}" name="soLuong-${hdct.id}" >
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">${formatVND(hdct.soLuong * hdct.sanPhamChiTiet.giaBan)}</td>
                                             <td class="px-6 py-4 whitespace-nowrap">
                                                <button class="deleteSP" data-id="${hdct.id}" id="xoaSP-${hdct.id}">
                                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-7" style="color: #B94A00">
                                                        <path fill-rule="evenodd" d="M7.22 3.22A.75.75 0 0 1 7.75 3h9A2.25 2.25 0 0 1 19 5.25v9.5A2.25 2.25 0 0 1 16.75 17h-9a.75.75 0 0 1-.53-.22L.97 10.53a.75.75 0 0 1 0-1.06l6.25-6.25Zm3.06 4a.75.75 0 1 0-1.06 1.06L10.94 10l-1.72 1.72a.75.75 0 1 0 1.06 1.06L12 11.06l1.72 1.72a.75.75 0 1 0 1.06-1.06L13.06 10l1.72-1.72a.75.75 0 0 0-1.06-1.06L12 8.94l-1.72-1.72Z" clip-rule="evenodd" />
                                                    </svg>
                                                </button>
                                             </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        `;
                    }

                    const tabIndex = tabsData.findIndex(tab => tab.id === idHoaDon);
                    if (tabIndex !== -1) {
                        tabsData[tabIndex].content = tabContent.innerHTML;
                        tabsData[tabIndex].contentLoaded = true;

                    }
                },


            });
        }



        function chuyenKhoan(amount, TxnRef){
            $.ajax({
                url: `/api/payment/create_payment?amount=${amount}&TxnRef=${TxnRef}&chuyenTrang=0`,
                method: 'GET',
                contentType: 'application/json',
                data:{},
                success: function (response) {
                    addPhuongThucThanhToanChuyenKhoan(idTabHD, amount);
                    window.location.href = response.url;
                },
            });
        }

        function addPhieuGiamGia(idHD, idPGG) {

            $.ajax({
                url: `/api/hoa-don/update-phieu-giam-gia/${idHD}`,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({
                    "phieuGiamGia": {
                        id: idPGG
                    }
                }),
                success: function(response) {
                    idPGG = null;



                },
                error: function(error) {
                    console.error("Error updating PhieuGiamGia", error);
                }
            });
        }


        function PhieuGiamGiaPhuHop(max) {

            $.ajax({
                url: `/api/hoa-don/phieu-giam-gia-phu-hop/${max}`,
                method: 'GET',
                contentType: 'application/json',
                success: function(response) {
                    if (response && response.length <= 0) {
                        idPGG = null;
                        maPGG = '';
                        GiamToiDa = 0;
                    } else if (max < response[0].donToiThieu) {
                        idPGG = null;
                        maPGG = '';
                        GiamToiDa = 0;
                    } else {
                        maPGG = response[0].ma;
                        // GiamToiDa = response[0].giamToiDa;
                        idPGG = response[0].id;
                        if(response[0].hinhThucGiam === true ){
                            let phanTram = max / response[0].giaTriGiam ;
                            if(response[0].giamToiDa < phanTram){
                                GiamToiDa = response[0]?.giamToiDa || 0;
                            }else{
                                GiamToiDa = phanTram;
                            }
                        }else{
                            GiamToiDa = response[0]?.giamToiDa || 0;
                        }
                    }
                    addPhieuGiamGia(idTabHD, idPGG);
                },
            });
        }


        function barcode(code){
            $.ajax({
                url: `/api/hoa-don/san-pham-ct/${code}`,
                method: 'Get',
                contentType: 'application/json',
                data: {},
                success: function (response) {
                    addSPBarcode(response.id);
                    getDuLieu(idTabHD);
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.error('Lỗi khi gọi API', textStatus, errorThrown);
                }
            });
        }

        function addSPBarcode(idSanPham){
            const soLuongMoi = 1;


            let checkTrung = false;

            let soLuongHienTai = 0;

            if (Array.isArray(idSP)) {
                for (let i = 0; i < idSP.length; i++) {
                    if (idSP[i].id === idSanPham) {
                        checkTrung = true;
                        soLuongHienTai = idSP[i].soLuong;
                        break;
                    }
                }
            }

            const soLuongCuoiCung = checkTrung ? soLuongHienTai + soLuongMoi : soLuongMoi;


            const capNhatSoLuongNeuTrung = {
                // gia: giaBan,
                soLuong: soLuongCuoiCung,
                trangThai: 1,
                hoaDon: { id: idTabHD },
                sanPhamChiTiet: { id: idSanPham }
            };

            if (!checkTrung) {
                $.ajax({
                    url: `/api/hoa-don/danh-sach-san-pham/add`,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                         soLuong: soLuongMoi,trangThai: 1, hoaDon: { id: idTabHD }, sanPhamChiTiet: { id: idSanPham }
                    }),
                    success: function () {
                        showNotification("Thêm sản pẩm thành công", "thanhCong")
                        hideModalSoLuong();
                        hideModalDanhSachSanPham();

                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.error('Lỗi khi gọi API', textStatus, errorThrown);
                    }
                });
            } else {
                $.ajax({
                    url: `/api/hoa-don/update-so-luong-sp`,
                    method: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify(capNhatSoLuongNeuTrung),
                    success: function () {
                        showNotification("Thêm sản pẩm thành công", "thanhCong")
                        hideModalSoLuong();
                        hideModalDanhSachSanPham();
                    },
                });
            }
            getDuLieu(idTabHD);

        }


        function getPhuongThucThanhToan(idTabHD) {
            $.ajax({
                url: `/api/hoa-don/phuong-thuc-thanh-toan/${idTabHD}`,
                method: 'GET',
                success: function (result) {
                    const listContainer = $("#listPhuongThucThanhToan");
                    listContainer.empty();

                    if (result.length === 0) {
                        tienDaThanhToan = 0;
                        $('#tienKhachDuoc').text(`${formatVND(0)}`);
                        listContainer.html(`
                    <tr>
                        <td colspan="4" class="px-6 py-4 text-center text-gray-500">Chưa thanh toán</td>
                    </tr>
                `);
                    } else {
                        tienDaThanhToan = 0;
                        let list = "";
                        for (let i = 0; i < result.length; i++) {
                            tienDaThanhToan += result[i].tienDaThanhToan;
                            list += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${i + 1}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${formatVND(result[i].tienDaThanhToan)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${result[i].tenThanhToan}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                          <button class="deletePTTT" data-id="${result[i].id}">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-7" style="color: #B94A00">
                                <path fill-rule="evenodd" d="M7.22 3.22A.75.75 0 0 1 7.75 3h9A2.25 2.25 0 0 1 19 5.25v9.5A2.25 2.25 0 0 1 16.75 17h-9a.75.75 0 0 1-.53-.22L.97 10.53a.75.75 0 0 1 0-1.06l6.25-6.25Zm3.06 4a.75.75 0 1 0-1.06 1.06L10.94 10l-1.72 1.72a.75.75 0 1 0 1.06 1.06L12 11.06l1.72 1.72a.75.75 0 1 0 1.06-1.06L13.06 10l1.72-1.72a.75.75 0 0 0-1.06-1.06L12 8.94l-1.72-1.72Z" clip-rule="evenodd" />
                            </svg>
                            </button>
                        </td>
                    </tr>`;
                        }
                        $('#tienKhachDuoc').text(`${formatVND(tienDaThanhToan)}`);
                        listContainer.html(list);
                    }
                },
                error: function (error) {
                    console.error('Lỗi Lịch sử thanh toán:', error);
                }
            });
        }



        function xoaSanPham(idHoaDon) {
            $(document).on('click', '.deleteSP', function () {
                const itemId = $(this).data('id');
                showConfirm(function() {
                    $.ajax({
                        url: `/api/hoa-don/delete-hd/${idHoaDon}`,
                        method: 'POST',
                        data: {idHoaDonCT: itemId},
                        success: function () {
                            showNotification("Xóa sản phẩm thành công", "thanhCong")
                            getDuLieu(idHoaDon);
                            PhieuGiamGiaPhuHop(tongTienTrongHD);
                            addPhieuGiamGia(idTabHD, idPGG);

                        },
                        error: function() {
                            Swal.fire(
                                'Lỗi!',
                                'Đã xảy ra lỗi khi xóa sản phẩm.',
                                'error'
                            );
                        }
                    });
                });
            });

        }


        function showConfirm(callback) {
            Swal.fire({
                title: 'Bạn có chắc chắn?',
                text: "Bạn không thể hoàn tác hành động này!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Vâng, tiếp tục!',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    callback();
                } else if (result.dismiss === Swal.DismissReason.cancel) {
                    Swal.fire(
                        'Đã hủy!',
                        'Hành động của bạn đã bị hủy.',
                        'error'
                    );
                }
            });
        }



        $(document).on('change', '.soLuong-input', function () {
            const id = $(this).data('id');
            const SoLuongMoi = $(this).val();

            $.ajax({
                url: `/api/hoa-don/update-so-luong/${id}`,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({id: id, soLuong: SoLuongMoi}),
                success: function (response) {
                    getDuLieu(idTabHD);
                    PhieuGiamGiaPhuHop(tongTienTrongHD);
                    addPhieuGiamGia(idTabHD, idPGG);
                },
                error: function (xhr, status, error) {
                    console.error('Lỗi khi cập nhật số lượng sản phẩm:', error);
                }
            });
        });


        function hienThiThongTinNguoiMua(hd) {


            if(hd.khachHang.id == 1){
                $('#thongTinNguoiMua').html(`
                    <div class="grid gap-4 grid-cols-2 m-10">
                        <div class="grid gap-4 grid-cols-2">
                            <div>
                                <p class="font-semibold">
                                    Tên khách hàng:
                                </p>
                            </div>
                            <div>
                                <p>
                                    <span class="bg-blue-400 hover:bg-blue-700 text-white py-1 px-2 rounded-full">
                                        ${hd.khachHang.ten}
                                    </span>
                                </p>
                            </div>
                        </div>
                    </div>
                `);
            }else{
                $('#thongTinNguoiMua').html(`
                    <div class="grid gap-4 grid-cols-2 ">
                        <div class="grid gap-4 grid-cols-2">

                        <div>
                            <p class="m-10">
                                Tên khách hàng:
                            </p>
                            <p class="m-10">
                                Số điện thoại:
                            </p>
                            <p class="m-10">
                                Gmail:
                            </p>
                        </div>

                        <div>
                            <p class="m-10">
                                 ${hd.khachHang.ten}
                            </p>
                            <p class="m-10">
                                ${hd.khachHang.sdt}
                            </p>
                            <p class="m-10">
                                ${hd.khachHang.email}
                            </p>
                        </div>
                        </div>

                    </div>
                `);
            }

            var tienShip = hd.tienShip || 0;
            var tongTien = hd.tongTien || 0;




            $('#thongTinThanhToan').html(`
                <div class="m-10 font-bold">
                    ${formatVND(tienDaThanhToan)}
                </div>
                <div class="flex items-center gap-2">
                    <input type="text" class="border border-brown-500 focus:border-black focus:outline-none p-1 rounded-md text-sm flex-1" value="${maPGG}">
                    <button class="bg-blue-500 hover:bg-blue-700 text-white px-2 rounded">
                        Chọn mã
                    </button>
                </div>
                <div class="m-10">
                    <span >VNĐ</span>
                </div>
                <div class="m-10">
                    <span >VNĐ</span>
                </div>
                <div class="m-10 font-bold">
                    ${formatVND(tongTien)}
                </div>
                <div class="m-10 font-bold">
                    ${formatVND(GiamToiDa)}
                </div>
                <div class="m-10 text-red-700 font-bold">
                    ${formatVND(tongTien - GiamToiDa)}
                </div>
            `);

        }

        $("#danhSachSanPham").on('click', '.themSanPham', function () {
            $(this).off('click');
            var tong = 0;
            $("#soLuongInput").val(1)
            showModalSoLuong();
            itemId = $(this).data('id');
            giaBan = $(this).data('gia-ban');
            tong = giaBan
            PhieuGiamGiaPhuHop(tongTienTrongHD);
        });

        $('#soLuongThayDoi').click(function () {

            const soLuongMoi = parseInt($("#soLuongInput").val(), 10);


            let checkTrung = false;

            let soLuongHienTai = 0;

            if (Array.isArray(idSP)) {
                for (let i = 0; i < idSP.length; i++) {
                    if (idSP[i].id === itemId) {
                        checkTrung = true;
                        soLuongHienTai = idSP[i].soLuong;
                        break;
                    }
                }
            }

            const soLuongCuoiCung = checkTrung ? soLuongHienTai + soLuongMoi : soLuongMoi;

            const capNhatSoLuongNeuTrung = {
                gia: giaBan,
                soLuong: soLuongCuoiCung,
                trangThai: 1,
                hoaDon: { id: idTabHD },
                sanPhamChiTiet: { id: itemId , giaBan: giaBan}
            };
                tongTienTrongHD;
            if (!checkTrung) {
                $.ajax({
                    url: `/api/hoa-don/danh-sach-san-pham/add`,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        gia: giaBan, soLuong: soLuongMoi,trangThai: 1, hoaDon: { id: idTabHD }, sanPhamChiTiet: { id: itemId,  giaBan:  giaBan }
                    }),
                    success: function () {
                        showNotification("Thêm sản pẩm thành công", "thanhCong")
                        hideModalSoLuong();
                        hideModalDanhSachSanPham();
                        getDuLieu(idTabHD);
                        PhieuGiamGiaPhuHop(tongTienTrongHD);
                        addPhieuGiamGia(idTabHD, idPGG);

                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.error('Lỗi khi gọi API', textStatus, errorThrown);
                    }
                });
            } else {
                $.ajax({
                    url: `/api/hoa-don/update-so-luong-sp`,
                    method: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify(capNhatSoLuongNeuTrung),
                    success: function () {
                        showNotification("Thêm sản pẩm thành công", "thanhCong")
                        hideModalSoLuong();
                        hideModalDanhSachSanPham();
                        getDuLieu(idTabHD);
                        PhieuGiamGiaPhuHop(tongTienTrongHD);
                        addPhieuGiamGia(idTabHD, idPGG);


                    },
                });
            }
            addPhieuGiamGia(idTabHD, idPGG);
            updateTongTien(tong, idTabHD);
            PhieuGiamGiaPhuHop(tong);

        });

        function getDiaChiKhachHang(idKhachHang) {
            if(idKhachHang != 1){
                $.ajax({
                    url: `/api/gio-hang/dia-chi-mac-dinh-khach-hang/${idKhachHang}`,
                    method: 'GET',
                    success: function (response) {
                        if (response && Object.keys(response).length > 0) {
                            updateThongTinNguoiNhan(response.idKH.ten, response.idKH.sdt, response.moTaChiTiet, 0, null, idTabHD);
                            getDuLieu(idTabHD);
                        } else {
                            console.log('Response trống');
                        }
                    },
                    error: function (error) {
                        console.error('Lỗi khi gọi API:', error);
                    }
                });
            }else {
                console.log('ID Khách Hàng là 1: Thực hiện các thao tác thiết lập giá trị giao diện');
                $('#edit-ten').val("Khách Vãng Lai");
                $('#edit-sdtNguoiNhan').val("");
                $('#noteThongTin').val("");
                $('#phiVanChuyen').val(0);
                splitAndPopulateAddress("1");
                getDuLieu(idTabHD);
                hideModalKhachHang();
            }

        }


        $(document).off('click', '.chonKhachHang').on('click', '.chonKhachHang', function () {
            const idKhachHang = $(this).data('id');
            getDiaChiKhachHang(idKhachHang);
            $.ajax({
                url: `/api/ban-hang/update-khach-hang/${idTabHD}`,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({
                    khachHang: {
                        id: idKhachHang
                    }
                }),
                success: function () {
                    hideModalKhachHang();
                    getDuLieu(idTabHD);
                },
            });

        });


        function updateThongTinNguoiNhan(nguoiNhan, sdtNguoiNhan, diaChiNguoiNhan, tienShip, ghichu, idhd) {
            $.ajax({
                url: `/api/hoa-don/update-thong-tin-nguoi-nhan/${idhd}`,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({
                    nguoiNhan: nguoiNhan, sdtNguoiNhan: sdtNguoiNhan, diaChiNguoiNhan: diaChiNguoiNhan, ghichu: ghichu, tienShip: tienShip
                }),
                success: function (response) {
                },
            });
        }

        function updateThongTinNguoiNhanCoTrangThai(nguoiNhan, sdtNguoiNhan, diaChiNguoiNhan, tienShip, ghichu, idhd, tt, tongTienSauKhiCoVoucher) {
            var ghiChu = "Hoàn thành";
            $.ajax({
                url: `/api/hoa-don/update-thong-tin-nguoi-nhan-hoa-don/${idhd}`,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({
                    nguoiNhan: nguoiNhan, sdtNguoiNhan: sdtNguoiNhan, diaChiNguoiNhan: diaChiNguoiNhan, ghichu: ghichu, tienShip: tienShip, trangThai: tt
                }),
                success: function (response) {
                    updateTongTien(tongTienSauKhiCoVoucher, idhd);
                    addPhuongThucThanhToanTienMatGiaoHang(idhd, tongTienSauKhiCoVoucher);
                    addHistoryLog(ghiChu, tt, idhd);
                },
            });
        }

        function updateTrangThaiHoaDon(trangThai, idHD) {
            var ghiChu = "Hoàn thành";
            $.ajax({
                url: `/api/hoa-don/update-trang-thai/${idHD}`,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({trangThai: trangThai}),
                success: function (response) {
                    console.log("set trang thai thanh cong")
                    addHistoryLog(ghiChu, trangThai, idHD);
                },
                error: function (xhr, status, error) {
                    console.error('Lỗi khi cập nhật trạng thái hóa đơn: ', error);
                    alert('Đã xảy ra lỗi khi cập nhật trạng thái hóa đơn. Vui lòng thử lại sau.');
                }
            });
        }

        function updateTrangThaiHoaDonTraSau(trangThai, idHD) {
            var ghiChu = "Hoàn thành";
            $.ajax({
                url: `/api/hoa-don/update-trang-thai/${idHD}`,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({trangThai: trangThai}),
                success: function (response) {
                    console.log("set trang thai thanh cong")
                    addHistoryLog(ghiChu, trangThai, idHD);
                },
                error: function (xhr, status, error) {
                    console.error('Lỗi khi cập nhật trạng thái hóa đơn: ', error);
                    alert('Đã xảy ra lỗi khi cập nhật trạng thái hóa đơn. Vui lòng thử lại sau.');
                }
            });
        }

        function addHistoryLog(ghiChu, hanhDong, idHD) {

            $.ajax({
                url: `/api/hoa-don/lich-su-hoa-don/add/${idHD}`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ghiChu: ghiChu, hanhDong: hanhDong}),
                success: function (response) {
                },

            });
        }

        $('#thanhToanTong').click(function () {
            getFormData();

            showConfirm(function () {
                if (checkThanhToan === 0) {
                    if(tongTienTrongHD - GiamToiDa === 0){
                        showNotification("Thanh toán thất bại", "thatBai");
                    } else if(tienDaThanhToan < tongTienTrongHD - GiamToiDa){
                        showNotification("Thanh toán thất bại", "thatBai");
                    } else {
                        updateTrangThaiHoaDon(6, idTabHD);
                        // updateTongTien(tongTienSauKhiCoVoucher, idTabHD);
                        renderTabs();
                        showNotification("Thanh toán thành công", "thanhCong");
                        window.location.href = 'http://localhost:3000/admin/ban-hang-tai-quay';
                    }
                } else if (checkThanhToan === 1) {
                    getFormData();
                    // updateTrangThaiHoaDonTraSau(1, idTabHD);
                    // updateTongTien(tongTienSauKhiCoVoucher, idTabHD);

                    updateThongTinNguoiNhanCoTrangThai(ten, sdtNguoiNhan, fullAddress, phiVanChuyen, noteThongTin, idTabHD, 1, tongTienSauKhiCoVoucher);
                    renderTabs();
                    showNotification("Đặt hàng thành công", "thanhCong");
                    window.location.href = 'http://localhost:3000/admin/ban-hang-tai-quay'
                }

            });
        });

        $('#btnTienMat').click(function () {
            tienDaThanhToan = $('#inputSoTien').val()
            addPhuongThucThanhToanTienMat(idTabHD, tienDaThanhToan);
            getDuLieu(idTabHD);
        });

        $('#btnChuyenKhoan').click(function () {
            tienDaThanhToan = $('#inputSoTien').val()
            chuyenKhoan(tienDaThanhToan, maHD);
            getDuLieu(idTabHD);
        });


        function addPhuongThucThanhToanTienMat(idHoaDon, tienDaThanhToan) {
            $.ajax({
                url: `/api/gio-hang/them-phuong-thuc-thanh-toan/${idHoaDon}`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    tienDaThanhToan: tienDaThanhToan,
                    tenThanhToan: "Tiền mặt",
                    loaiThanhToan: true,
                    trangThai: 1
                }),
                success: function (response) {
                    getDuLieu(idTabHD);
                },
            });
        }

        function addPhuongThucThanhToanTienMatGiaoHang(idHoaDon, tienDaThanhToan) {
            $.ajax({
                url: `/api/gio-hang/them-phuong-thuc-thanh-toan/${idHoaDon}`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    tienDaThanhToan: tienDaThanhToan,
                    tenThanhToan: "Tiền mặt",
                    loaiThanhToan: false,
                    trangThai: 1
                }),
                success: function (response) {
                    getDuLieu(idTabHD);
                },
            });
        }

        function addPhuongThucThanhToanChuyenKhoan(idHoaDon, tienDaThanhToan) {
            $.ajax({
                url: `/api/gio-hang/them-phuong-thuc-thanh-toan/${idHoaDon}`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    tienDaThanhToan: tienDaThanhToan,
                    tenThanhToan: "Chuyển Khoản",
                    loaiThanhToan: true,
                    trangThai: 1
                }),
                success: function (response) {
                    getDuLieu(idTabHD);
                },
            });
        }
        //
        // function updateThongTinNguoiNhan(nguoiNhan, sdtNguoiNhan) {
        //     $.ajax({
        //         url: `/api/ban-hang/update-thong-tin-nguoi-nhan/${idTabHD}`,
        //         method: 'PUT',
        //         contentType: 'application/json',
        //         data: JSON.stringify({
        //             nguoiNhan: nguoiNhan,
        //             sdtNguoiNhan: sdtNguoiNhan
        //         }),
        //         success: function (response) {
        //             getDuLieu(idTabHD);
        //         },
        //     });
        // }

        const DateNow = new Date();
        const DateShip = DateNow.setDate(DateNow.getDate() + 4);

        function formatDateFromTimestamp(timestamp) {
            const date = new Date(timestamp);

            const day = date.getDate();
            const month = date.getMonth() + 1;
            const year = date.getFullYear();

            return `${day}/${month}/${year}`;
        }

        function findDiaChiKhachHang(specificAddress, city, district, ward) {
            const addressParts = address.split(',').map(part => part.trim());
            const len = addressParts.length;

                $('#edit-diachi').val(specificAddress);

                setTimeout(function() {

                    $editTinhThanh.val($editTinhThanh.find("option:contains('" + city + "')").val()).change();
                }, 100);

                setTimeout(function() {

                    $editQuanHuyen.val($editQuanHuyen.find("option:contains('" + district + "')").val()).change();
                }, 100);

                setTimeout(function() {
                    $editPhuongXa.val($editPhuongXa.find("option:contains('" + ward + "')").val());
                }, 100);

        }

        function thongTinShip(hd){

            $('#edit-ten').val(hd.nguoiNhan);
            $('#edit-sdtNguoiNhan').val(hd.sdtNguoiNhan);
            $('#edit-email').val(hd.khachHang.email);


            $('#phiVanChuyen').val(hd.tienShip);
            $('#noteThongTin').val(hd.ghiChu);

            $('#thoiGianDuKien').text(formatDateFromTimestamp(DateShip))

        }



        function toggleThongTinShip() {
            $('#toggle-button').on('click', function() {
                $(this).toggleClass('active');

                if ($(this).hasClass('active')) {
                    $('#traSau-button').prop('disabled', false);
                    $('#traSau-wrapper').removeClass('d-none');
                    hideThongTinShip2();
                    showThongTinShip();
                    checkThanhToan = $('#traSau-button').hasClass('active') ? 1 : 0;
                    getFormData();
                } else {
                    $('#traSau-button').prop('disabled', true);
                    $('#traSau-wrapper').addClass('d-none');
                    $('#traSau-button').removeClass('active');
                    hideThongTinShip();
                    showThongTinShip2();
                    checkThanhToan = 0;
                }
            });

            $('#traSau-button').on('click', function() {
                if (!$(this).prop('disabled')) {
                    $(this).toggleClass('active');

                    checkThanhToan = $(this).hasClass('active') ? 1 : 0;
                    console.log(checkThanhToan);
                }
            });
            console.log(checkThanhToan);

        }

        function updateTongTien(tongTien, idHoaDon) {
            $.ajax({
                url: `/api/hoa-don/update-tong-tien/${idHoaDon}`,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({tongTien: tongTien, tongTienSauGiam: tongTien}),
                success: function (response) {
                    console.log("Update tong tien thanh cong")
                },
            });
        }

        function splitAndPopulateAddress(address) {
            if (!address) {
                console.error('Address is null or undefined');
                return;
            }

            const addressParts = address.split(',').map(part => part.trim());
            const len = addressParts.length;

            if (len >= 4) {
                const city = addressParts[len - 1];
                const district = addressParts[len - 2];
                const ward = addressParts[len - 3];
                const specificAddress = addressParts.slice(0, len - 3).join(', ');

                $('#edit-diachi').val(specificAddress);

                setTimeout(function() {
                    $editTinhThanh.val($editTinhThanh.find("option:contains('" + city + "')").val()).change();
                }, 100);

                setTimeout(function() {
                    $editQuanHuyen.val($editQuanHuyen.find("option:contains('" + district + "')").val()).change();
                }, 100);

                setTimeout(function() {
                    $editPhuongXa.val($editPhuongXa.find("option:contains('" + ward + "')").val());
                }, 100);
            } else {
                console.error('Invalid address format:', address);
            }
        }


        function getThongTinKhachHang() {
            $.ajax({
                url: 'https://raw.githubusercontent.com/kenzouno1/DiaGioiHanhChinhVN/master/data.json',
                dataType: 'json',
                success: function(data) {
                    citiesData = data;
                    $editTinhThanh.empty().append('<option value="" selected>Chọn tỉnh thành</option>');
                    $.each(data, function(index, city) {
                        $editTinhThanh.append('<option value="' + city.Id + '">' + city.Name + '</option>');
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Lỗi khi tải dữ liệu:', error);
                }
            });

            $editTinhThanh.on('change', function() {
                var cityId = $(this).val();
                if (cityId) {
                    $editQuanHuyen.empty().append('<option value="" selected>Chọn quận huyện</option>');
                    var selectedCity = citiesData.find(city => city.Id === cityId);
                    if (selectedCity) {
                        $.each(selectedCity.Districts, function(index, district) {
                            $editQuanHuyen.append('<option value="' + district.Id + '">' + district.Name + '</option>');
                        });
                    }
                } else {
                    $editQuanHuyen.empty().append('<option value="" selected>Chọn quận huyện</option>');
                    $editPhuongXa.empty().append('<option value="" selected>Chọn phường xã</option>');
                }
            });

            $editQuanHuyen.on('change', function() {
                var districtId = $(this).val();
                if (districtId) {
                    // Clear and populate phường/xã dropdown
                    $editPhuongXa.empty().append('<option value="" selected>Chọn phường xã</option>');
                    var selectedDistrict = citiesData.flatMap(city => city.Districts).find(district => district.Id === districtId);
                    if (selectedDistrict) {
                        $.each(selectedDistrict.Wards, function(index, ward) {
                            $editPhuongXa.append('<option value="' + ward.Id + '">' + ward.Name + '</option>');
                        });
                    }
                } else {
                    $editPhuongXa.empty().append('<option value="" selected>Chọn phường xã</option>');
                }
            });
        }

        function cbbKichCo(){
            $.ajax({
                url: `/api/kich-co/all`,
                method: 'GET',
                success: function(data) {
                    $('#combo-box-kich-co').empty();

                    $('#combo-box-kich-co').append('<option value="">Tất cả</option>');

                    $.each(data, function(index, item) {
                        $('#combo-box-kich-co').append(`<option value="${item.id}">${item.ten}</option>`);
                    });
                },

            });
        }


        function cbbMauSac(){
            $.ajax({
                url: `/api/mau-sac/all`,
                method: 'GET',
                success: function(data) {
                    $('#combo-box-mau-sac').empty();

                    $('#combo-box-mau-sac').append('<option value="">Tất cả</option>');

                    $.each(data, function(index, item) {
                        $('#combo-box-mau-sac').append(`<option value="${item.id}">${item.moTa}</option>`);
                    });
                },

            });
        }


        function cbbChatLieu(){
            $.ajax({
                url: `/api/chat-lieu/all`,
                method: 'GET',
                success: function(data) {
                    $('#combo-box-chat-lieu').empty();

                    $('#combo-box-chat-lieu').append('<option value="">Tất cả</option>');

                    $.each(data, function(index, item) {
                        $('#combo-box-chat-lieu').append(`<option value="${item.id}">${item.ten}</option>`);
                    });
                },

            });
        }

        function cbbDeGiay(){
            $.ajax({
                url: `/api/de-giay/all`,
                method: 'GET',
                success: function(data) {
                    $('#combo-box-de-giay').empty();

                    $('#combo-box-de-giay').append('<option value="">Tất cả</option>');

                    $.each(data, function(index, item) {
                        $('#combo-box-de-giay').append(`<option value="${item.id}">${item.ten}</option>`);
                    });
                },

            });
        }

        function cbbCoGiay(){
            $.ajax({
                url: `/api/co-giay/all`,
                method: 'GET',
                success: function(data) {
                    $('#combo-box-co-giay').empty();

                    $('#combo-box-co-giay').append('<option value="">Tất cả</option>');

                    $.each(data, function(index, item) {
                        $('#combo-box-co-giay').append(`<option value="${item.id}">${item.ten}</option>`);
                    });
                },

            });
        }

        function cbbThuongHieu(){
            $.ajax({
                url: `/api/thuong-hieu/all`,
                method: 'GET',
                success: function(data) {
                    $('#combo-box-thuong-hieu').empty();

                    $('#combo-box-thuong-hieu').append('<option value="">Tất cả</option>');

                    $.each(data, function(index, item) {
                        $('#combo-box-thuong-hieu').append(`<option value="${item.id}">${item.ten}</option>`);
                    });
                },

            });
        }
        addKhachHangNhanh();

        function addKhachHangNhanh() {
            $('#dongYThemKhachHang').click(function () {
                var ten = $('#tenKH').val();
                var sdt = $('#SDT').val();

                showConfirm(function() {
                    $.ajax({
                        url: `/api/khach-hang/add-khach-hang-nhanh`,
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({ten: ten, sdt: sdt}),
                        success: function () {
                            showNotification("Thêm khách hàng thành công", "thanhCong");
                            getDuLieu(idHoaDon);
                            hiddenModalThemKhachHang();
                            showModalKhachHang();
                            PhieuGiamGiaPhuHop(tongTienTrongHD);
                            addPhieuGiamGia(idTabHD, idPGG);
                        },

                    });
                });
            });
        }




        function showModalThemKhachHang() {
            $('#modalThemKhachHang').removeClass('hidden');
        }

        function hiddenModalThemKhachHang() {
            $('#modalThemKhachHang').addClass('hidden');
            $('#modalThemKhachHang').val('');
        }

        function showModalThanhToan() {
            $('#modalThanhToan').removeClass('hidden');
        }

        function hiddenModalThanhToan() {
            $('#modalThanhToan').addClass('hidden');
            $('#modalThanhToan').val('');
        }

        function showModalDanhSachSanPham() {
            $('#modalDachSachSanPham').removeClass('hidden');
        }

        function hideModalDanhSachSanPham() {
            $('#modalDachSachSanPham').addClass('hidden');
            $('#modalDachSachSanPham').val('');

        }

        function showThongTinShip2() {
            $('#thongTinShip2').removeClass('hidden');
        }

        function hideThongTinShip2() {
            $('#thongTinShip2').addClass('hidden');
            $('#thongTinShip2').val('');
        }

        function showThongTinShip() {
            $('#thongTinShip').removeClass('hidden');
        }

        function hideThongTinShip() {
            $('#thongTinShip').addClass('hidden');
            $('#thongTinShip').val('');
        }

        $('#themKH').click(function () {
            hideModalKhachHang();
            showModalThemKhachHang();
        });

        $('#dongThemKhachHang').click(function () {
            hiddenModalThemKhachHang()
        });

        $('#hienThiDanhSachSanPham').click(function () {
            showModalDanhSachSanPham();
        });

        $('#dongDanhSachSanPham').click(function () {
            hideModalDanhSachSanPham();
        });

        function showModalKhachHang() {
            $('#modalKhachHang').removeClass('hidden');
        }

        function hideModalKhachHang() {
            $('#modalKhachHang').addClass('hidden');
            $('#modalKhachHang').val('');
        }

        $('#chonTaiKhoan').click(function () {
            showModalKhachHang();
            getDuLieu(idTabHD);
        });

        $('#dongKhachHang').click(function () {
            hideModalKhachHang();
        });


        $('#thanhToan').click(function () {
            showModalThanhToan();
            getDuLieu(idTabHD);
        });

        $('#dongModalSoLuong').click(function () {
            hideModalSoLuong();
        });

        $('#xacNhanThanhToan').click(function () {
            getDuLieu(idTabHD);
            hiddenModalThanhToan();

        });


        function showModalSoLuong() {
            $('#modalSoLuong').removeClass('hidden');
        }

        function hideModalSoLuong() {
            $('#modalSoLuong').addClass('hidden');
            $('#modalSoLuong').val('');
            $('#modalSoLuong').addClass('hidden');
        }

        xoaPhuongThucThanhToan();

        function xoaPhuongThucThanhToan() {
            $('#listPhuongThucThanhToan').on('click', '.deletePTTT', function () {
                const itemId = $(this).data('id');
                showConfirm(function() {
                    $.ajax({
                        url: `/api/hoa-don/xoa-phuong-thuc-thanh-toan/${itemId}`,
                        method: 'POST',
                        success: function () {
                            showNotification("Xóa phương thức thanh toán", "thanhCong");
                            getPhuongThucThanhToan(idTabHD);
                            getDuLieu(idTabHD);
                        },
                    });
                });
            });
        }

        function startScanner() {
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#interactive'),
                    constraints: {
                        width: 320,
                        height: 240,
                        facingMode: "environment"
                    }
                },
                decoder: {
                    readers: [
                        "code_128_reader",
                        "ean_reader",
                        "ean_8_reader",
                        "code_39_reader",
                        "code_39_vin_reader",
                        "codabar_reader",
                        "upc_reader",
                        "upc_e_reader",
                        "i2of5_reader",
                        "2of5_reader",
                        "code_93_reader"
                    ]
                },
                locate: true,
                locator: {
                    patchSize: "medium",
                    halfSample: true
                }
            }, function(err) {
                if (err) {
                    console.error(err);
                    $('#error-message').text('Error initializing QuaggaJS: ' + err);
                    return;
                }
                Quagga.start();
            });

            Quagga.onProcessed(function(result) {
                var drawingCtx = Quagga.canvas.ctx.overlay,
                    drawingCanvas = Quagga.canvas.dom.overlay;

                if (result) {
                    if (result.boxes) {
                        drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
                        result.boxes.filter(function(box) {
                            return box !== result.box;
                        }).forEach(function(box) {
                            Quagga.ImageDebug.drawPath(box, { x: 0, y: 1 }, drawingCtx, {
                                color: "green",
                                lineWidth: 2
                            });
                        });
                    }

                    if (result.box) {
                        Quagga.ImageDebug.drawPath(result.box, { x: 0, y: 1 }, drawingCtx, {
                            color: "blue",
                            lineWidth: 2
                        });
                    }

                    if (result.codeResult && result.codeResult.code) {
                        $('#scanned-barcode').text(result.codeResult.code);
                    }
                }
            });

            Quagga.onDetected(function(result) {
                var code = result.codeResult.code;
                console.log(code);
                barcode(code);
                $('#scanned-barcode').text(code);
                Quagga.stop(); // Stop scanning after detection
                $('#modal').hide(); // Hide modal
            });
        }

        $('#start-camera').on('click', function() {
            $('#modal').show();
            startScanner();
        });

        function showNotification(message, status) {
            var notification = document.getElementById('notification');
            var notificationMessage = document.getElementById('notification-message');
            var progressBar = document.getElementById('progress-bar');

            notification.className = 'notification'; // Reset class
            if (status === 'thanhCong') {
                notification.classList.add('thanhCong');
            } else if (status === 'thatBai') {
                notification.classList.add('thatBai');
            }

            if (message) {
                notificationMessage.textContent = message;
                notification.style.display = 'block';
                progressBar.style.width = '100%';

                setTimeout(function() {
                    progressBar.style.width = '0';
                }, 10);

                setTimeout(function() {
                    notification.style.display = 'none';
                    progressBar.style.width = '100%';
                }, 3010);
            }
        }


        getDanhSachSanPhamCoSearch(page, size);

        toggleThongTinShip();
        getThongTinKhachHang();
        idHoaDon();
        getKhachHang(pageKH, sizeKH);
        // getDanhSachSanPham(0, 5);

    });

    let sdt = '';

    let idChatLieu = '';
    let idCoGiay = '';
    let idDeGiay = ''
    let idKichCo = '';
    let idMauSac = '';
    let idThuongHieu = '';
    let keyword = '';
    let giaBanMin = '';
    let giaBanMax = '';
    let page = 0
    let size = 5;
    let pageKH = 0;
    let sizeKH = 5;

    $('#timKiemBlaBla').click(function() {
        idChatLieu = $('#combo-box-chat-lieu').val();
        idMauSac = $('#combo-box-mau-sac').val();
        idKichCo = $('#combo-box-kich-co').val();
        idCoGiay = $('#combo-box-co-giay').val();
        idDeGiay = $('#combo-box-de-giay').val();
        idThuongHieu = $('#combo-box-thuong-hieu').val();
        keyword = $('#input-TimKiem').val();
        page = 0;
        getDanhSachSanPhamCoSearch(page, size);
    });

    $('#tuBoTatCa').click(function() {
        // Reset các giá trị tìm kiếm
        $('#combo-box-chat-lieu').prop('selectedIndex', 0);
        $('#combo-box-mau-sac').prop('selectedIndex', 0);
        $('#combo-box-kich-co').prop('selectedIndex', 0);
        $('#combo-box-co-giay').prop('selectedIndex', 0);
        $('#combo-box-de-giay').prop('selectedIndex', 0);
        $('#combo-box-thuong-hieu').prop('selectedIndex', 0);
        $('#input-TimKiem').val('');

        idChatLieu = '';
        idMauSac = '';
        idKichCo = '';
        idCoGiay = '';
        idDeGiay = '';
        idThuongHieu = '';
        keyword = '';
        page = 0;

        getDanhSachSanPhamCoSearch(page, size);
    });

    const getDanhSachSanPhamCoSearch = (page, size) => {
        $.ajax({
            url: `/api/hoa-don/searchBlaBla?idChatLieu=${idChatLieu}&idCoGiay=${idCoGiay}&idDeGiay=${idDeGiay}&idKichCo=${idKichCo}&idMauSac=${idMauSac}&idThuongHieu=${idThuongHieu}&keyword=${keyword}&giaBanMin=${giaBanMin}&giaBanMax=${giaBanMax}&page=${page}&size=${size}`,
            method: 'GET',
            success: function (result) {
                let list = "";
                $("#danhSachSanPham").empty();
                for (let i = 0; i < result.content.length; i++) {
                    list += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${i + 1}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <img src="${result.content[i].anh}" alt="Ảnh" class="w-16 h-auto">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap font-bold">
                            <h1>${result.content[i].ten}-${result.content[i].mauSac.moTa}</h1>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">${formatVND(result.content[i].giaBan)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${result.content[i].soLuong}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${result.content[i].kichCo.ten}</td>
                        <td>
                            <div class="color-container rounded-lg ml-5 border-3" style="background-color: ${result.content[i].mauSac.ten}; width: 50px; height: 20px;"></div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="bg-green-500 rounded-lg text-white px-2 py-1">${trangThaiSP(result.content[i].trangThai)}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button id="hienThiDanhSachSanPham" class="themSanPham bg-blue-500 text-white px-4 py-2 rounded h-[50%] mt-1 hover:bg-blue-600 hover:text-gray-100" data-id="${result.content[i].id}" data-gia-ban="${result.content[i].giaBan}">Thêm</button>
                        </td>
                    </tr>`;
                }

                $("#danhSachSanPham").html(list);

                let pagination = '';
                pagination += `
                <button class="px-4 py-2 bg-gray-300 text-black rounded-md mx-1" onclick="getDanhSachSanPhamCoSearch(${result.pageable.pageNumber - 1}, ${size})" ${result.pageable.pageNumber === 0 ? 'disabled' : ''}>Previous</button>
            `;

                const maxVisiblePages = 3;
                const halfVisiblePages = Math.floor(maxVisiblePages / 2);
                let startPage = Math.max(1, result.pageable.pageNumber + 1 - halfVisiblePages);
                let endPage = Math.min(startPage + maxVisiblePages - 1, result.totalPages);

                if (startPage > 1) {
                    pagination += `
                    <button class="px-4 py-2 bg-blue-300 text-white rounded-md mx-1" onclick="getDanhSachSanPhamCoSearch(0, ${size})">1</button>
                `;
                    if (startPage > 2) {
                        pagination += `<span class="px-4 py-2">...</span>`;
                    }
                }

                for (let i = startPage; i <= endPage; i++) {
                    pagination += `
                    <button class="px-4 py-2 bg-blue-300 text-white rounded-md mx-1 ${i === result.pageable.pageNumber + 1 ? 'bg-blue-600 text-white' : ''}" onclick="getDanhSachSanPhamCoSearch(${i - 1}, ${size})">${i}</button>
                `;
                }

                if (endPage < result.totalPages) {
                    if (endPage < result.totalPages - 1) {
                        pagination += `<span class="px-4 py-2">...</span>`;
                    }

                    pagination += `
                    <button class="px-4 py-2 bg-blue-300 text-white rounded-md mx-1" onclick="getDanhSachSanPhamCoSearch(${result.totalPages - 1}, ${size})">${result.totalPages}</button>
                `;
                }

                pagination += `
                <button class="px-4 py-2 bg-gray-300 text-black rounded-md mx-1" onclick="getDanhSachSanPhamCoSearch(${result.pageable.pageNumber + 1}, ${size})" ${result.pageable.pageNumber + 1 === result.totalPages ? 'disabled' : ''}>Next</button>
            `;

                $("#paginationSP").html(pagination);
            }
        });
    };

    $('#timKiemSDT').click(function() {
        sdt = $('#input-TimKiemSDT').val();
        pageKH = 0;
        getKhachHang(pageKH, sizeKH);
    });

    $('#tuBoTatCaSDT').click(function() {

        $('#input-TimKiemSDT').val('');

        sdt = '';
        pageKH = 0;

        getKhachHang(pageKH, sizeKH);
    });


    const getKhachHang = (page , size) => {
        $.ajax({
            url: `/api/ban-hang/khach-hang?sdt=${sdt}&page=${page}&size=${size}`,
            method: 'GET',
            data: {},
            success: function (result) {
                let list = "";
                $("#listKhachHang").empty();
                for (let i = 0; i < result.content.length; i++) {
                    list += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${i + 1}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${result.content[i].ten}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${result.content[i].email}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${result.content[i].sdt}</td>
                      <td>
                       <button class="chonKhachHang bg-blue-500 hover:bg-blue-700 text-white py-1 px-2 rounded mr-3" data-id="${result.content[i].id}" data-nguoi-nhan="${result.content[i].ten}" data-sdt-nguoi-nhan="${result.content[i].sdt}">
                            Chọn
                        </button>
                        </td>
                    </tr>
                `;
                }

                $("#listKhachHang").html(list);

                let pagination = '';
                pagination += `
                <button class="px-4 py-2 bg-gray-300 text-black rounded-md mx-1" onclick="getKhachHang(${result.pageable.pageNumber - 1}, ${size})" ${result.pageable.pageNumber === 0 ? 'disabled' : ''}>Previous</button>
                `;

                const maxVisiblePages = 3;
                const halfVisiblePages = Math.floor(maxVisiblePages / 2);
                let startPage = Math.max(1, result.pageable.pageNumber + 1 - halfVisiblePages);
                let endPage = Math.min(startPage + maxVisiblePages - 1, result.totalPages);

                if (startPage > 1) {
                    pagination += `
                    <button class="px-4 py-2 bg-blue-300 text-white rounded-md mx-1" onclick="getKhachHang(0, ${size})">1</button>
                `;
                    if (startPage > 2) {
                        pagination += `<span class="px-4 py-2">...</span>`;
                    }
                }

                for (let i = startPage; i <= endPage; i++) {
                    pagination += `
                    <button class="px-4 py-2 bg-blue-300 text-white rounded-md mx-1 ${i === result.pageable.pageNumber + 1 ? 'bg-blue-600 text-white' : ''}" onclick="getKhachHang(${i - 1}, ${size})">${i}</button>
                `;
                }

                if (endPage < result.totalPages) {
                    if (endPage < result.totalPages - 1) {
                        pagination += `<span class="px-4 py-2">...</span>`;
                    }
                    pagination += `
                    <button class="px-4 py-2 bg-blue-300 text-white rounded-md mx-1" onclick="getKhachHang(${result.totalPages - 1}, ${size})">${result.totalPages}</button>
                `;
                }

                pagination += `
                <button class="px-4 py-2 bg-gray-300 text-black rounded-md mx-1" onclick="getKhachHang(${result.pageable.pageNumber + 1}, ${size})" ${result.pageable.pageNumber + 1 === result.totalPages ? 'disabled' : ''}>Next</button>
                `;

                $("#pagination").html(pagination);
            }
        });
    }

    const formatVND = (tongtien) => {
        return tongtien.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".") + ' VNĐ';
    }

    const getDanhSachSanPham = (page , size ) => {
        $.ajax({
            url: `/api/hoa-don/danh-sach-san-pham?page=${page}&size=${size}`,
            method: 'GET',
            success: function (result) {
                let list = "";
                $("#danhSachSanPham").empty();
                for (let i = 0; i < result.content.length; i++) {
                    list += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${i + 1}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <img src="${result.content[i].anh}" alt="Ảnh" class="w-16 h-auto">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap font-bold">
                            <h1>${result.content[i].ten}</h1>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">${formatVND(result.content[i].giaBan)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${result.content[i].soLuong}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${result.content[i].kichCo.ten}</td>
                        <td>
                            <div class="color-container rounded-lg ml-5 border-3" style="background-color: ${result.content[i].mauSac.ten}; width: 50px; height: 20px;"></div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="bg-green-500 rounded-lg text-white px-2 py-1">${trangThaiSP(result.content[i].trangThai)}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                           <button id="hienThiDanhSachSanPham" class="themSanPham bg-blue-500 text-white px-4 py-2 rounded h-[50%] mt-1 hover:bg-blue-600 hover:text-gray-100" data-id="${result.content[i].id}" data-gia-ban="${result.content[i].giaBan}">Thêm
                            </button>
                        </td>
                    </tr>`;
                }

                $("#danhSachSanPham").html(list);

                let pagination = '';
                pagination += `
                <button class="px-4 py-2 bg-gray-300 text-black rounded-md mx-1" onclick="getDanhSachSanPham(${result.pageable.pageNumber - 1}, ${size})" ${result.pageable.pageNumber === 0 ? 'disabled' : ''}>Previous</button>
            `;

                const maxVisiblePages = 3;
                const halfVisiblePages = Math.floor(maxVisiblePages / 2);
                let startPage = Math.max(1, result.pageable.pageNumber + 1 - halfVisiblePages);
                let endPage = Math.min(startPage + maxVisiblePages - 1, result.totalPages);

                if (startPage > 1) {
                    pagination += `
                    <button class="px-4 py-2 bg-blue-300 text-white rounded-md mx-1" onclick="getDanhSachSanPham(0, ${size})">1</button>
                `;
                    if (startPage > 2) {
                        pagination += `<span class="px-4 py-2">...</span>`;
                    }
                }

                for (let i = startPage; i <= endPage; i++) {
                    pagination += `
                    <button class="px-4 py-2 bg-blue-300 text-white rounded-md mx-1 ${i === result.pageable.pageNumber + 1 ? 'bg-blue-600 text-white' : ''}" onclick="getDanhSachSanPham(${i - 1}, ${size})">${i}</button>
                `;
                }

                if (endPage < result.totalPages) {
                    if (endPage < result.totalPages - 1) {
                        pagination += `<span class="px-4 py-2">...</span>`;
                    }
                    pagination += `
                    <button class="px-4 py-2 bg-blue-300 text-white rounded-md mx-1" onclick="getDanhSachSanPham(${result.totalPages - 1}, ${size})">${result.totalPages}</button>
                `;
                }

                pagination += `
                <button class="px-4 py-2 bg-gray-300 text-black rounded-md mx-1" onclick="getDanhSachSanPham(${result.pageable.pageNumber + 1}, ${size})" ${result.pageable.pageNumber + 1 === result.totalPages ? 'disabled' : ''}>Next</button>
            `;

                $("#paginationSP").html(pagination);
            }

        });
    };

    const trangThaiSP = (tt) => {
        switch (tt) {
            case 1:
                return 'Còn hàng';
            case 2:
                return 'Hết hàng';
            default:
                return 'Không xác định'
        }
    }



    // function showNotification(message, status) {
    //     var notification = document.getElementById('notification');
    //     var notificationMessage = document.getElementById('notification-message');
    //     var progressBar = document.getElementById('progress-bar');
    //
    //     notification.className = 'notification'; // Reset class
    //     if (status === 'thanhCong') {
    //         notification.classList.add('thanhCong');
    //     } else if (status === 'thatBai') {
    //         notification.classList.add('thatBai');
    //     }
    //
    //     if (message) {
    //         notificationMessage.textContent = message;
    //         notification.style.display = 'block';
    //         progressBar.style.width = '100%';
    //
    //         setTimeout(function() {
    //             progressBar.style.width = '0';
    //         }, 10);
    //
    //         setTimeout(function() {
    //             notification.style.display = 'none';
    //             progressBar.style.width = '100%';
    //         }, 3010);
    //     }
    // }




</script>

<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script th:src="@{/assets/js/main.js}"></script>

</body>
</html>
